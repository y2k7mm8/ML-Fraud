<!doctype html>
<html lang="ru">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Anti-Fraud</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap"
            rel="stylesheet"
        />
        <link rel="stylesheet" href="/css/app.css" />
    </head>
    <body>
        <div class="container">
            <header class="header">
                <div>
                    <h1>Anti‚ÄëFraud</h1>
                    <p class="sub">
                        –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –≤ API –∏ –ø–æ–ª—É—á–∞–µ—Ç fraud‚Äëscore
                    </p>
                </div>
                <span class="badge">MSc / ML</span>
            </header>

            <div class="grid">
                <!-- FORM -->
                <section class="card">
                    <h2>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</h2>

                    <form id="txForm" class="form">
                        <label class="field">
                            <span>–°—É–º–º–∞ (amount)</span>
                            <input
                                type="number"
                                step="0.01"
                                min="0"
                                name="amount"
                                value="1200"
                                required
                            />
                        </label>

                        <label class="field">
                            <span>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å</span>
                            <input
                                type="number"
                                min="0"
                                name="transactions_last_hour"
                                value="2"
                                required
                            />
                        </label>

                        <label class="field">
                            <span>–î–∏—Å—Ç–∞–Ω—Ü–∏—è –æ—Ç –ø—Ä–æ—à–ª–æ–π –ª–æ–∫–∞—Ü–∏–∏ (–∫–º)</span>
                            <input
                                type="number"
                                step="0.01"
                                min="0"
                                name="distance_from_last_location"
                                value="0.8"
                                required
                            />
                        </label>

                        <div class="actions">
                            <button class="btn" type="submit">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                            <button
                                class="btn btn-ghost"
                                type="button"
                                id="fillFraud"
                            >
                                –ü—Ä–∏–º–µ—Ä ‚Äú—Ñ—Ä–æ–¥‚Äù
                            </button>
                        </div>

                        <p class="hint">
                            API: <code id="apiUrl">/api/check-transaction</code>
                        </p>
                    </form>
                </section>

                <!-- RESULT -->
                <section class="card">
                    <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç</h2>

                    <div id="status" class="status">
                        <div class="status-inner">
                            –û–∂–∏–¥–∞—é –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç–ø—Ä–∞–≤–∫—É –∑–∞–ø—Ä–æ—Å–∞
                        </div>
                    </div>

                    <div class="metrics">
                        <div class="metric">
                            <div class="metric-label">fraud_score</div>
                            <div class="metric-value" id="score">‚Äî</div>
                        </div>
                        <div class="metric">
                            <div class="metric-label">is_fraud</div>
                            <div class="metric-value" id="isFraud">‚Äî</div>
                        </div>
                    </div>

                    <div style="margin-top: 12px">
                        <div class="score-wrap">
                            <div
                                style="
                                    flex: 0 0 140px;
                                    font-size: 13px;
                                    color: var(--muted);
                                "
                            >
                                Score vs threshold
                            </div>
                            <div class="gauge" aria-hidden>
                                <div id="gfill" class="gauge-fill"></div>
                            </div>
                            <div class="gauge-label" id="glabel">‚Äî</div>
                        </div>
                        <details class="raw">
                            <summary
                                style="
                                    margin-top: 10px;
                                    cursor: pointer;
                                    color: var(--muted);
                                "
                            >
                                Raw JSON
                            </summary>
                            <pre id="rawJson">{}</pre>
                        </details>
                    </div>
                </section>
            </div>

            <!-- HISTORY -->
            <section class="card">
                <div class="row">
                    <h2>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤</h2>
                    <button class="btn btn-small btn-ghost" id="clear">
                        –û—á–∏—Å—Ç–∏—Ç—å
                    </button>
                </div>

                <div class="table-wrap">
                    <table class="table" id="historyTable">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>amount</th>
                                <th>tx_last_hour</th>
                                <th>distance_km</th>
                                <th>fraud_score</th>
                                <th>is_fraud</th>
                                <th>time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr class="empty">
                                <td colspan="7">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <footer class="footer"></footer>
        </div>

        <script>
            // üîß –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç Laravel (–¥—Ä—É–≥–æ–π –¥–æ–º–µ–Ω/–ø–æ—Ä—Ç), —É–∫–∞–∂–∏ –ø–æ–ª–Ω—ã–π URL:
            // const API = "http://127.0.0.1:8000/api/check-transaction";
            const API = document.getElementById("apiUrl").textContent;

            const form = document.getElementById("txForm");
            const statusEl = document.getElementById("status");
            const scoreEl = document.getElementById("score");
            const isFraudEl = document.getElementById("isFraud");
            const rawEl = document.getElementById("rawJson");

            const fillFraudBtn = document.getElementById("fillFraud");
            const clearBtn = document.getElementById("clear");
            const tableBody = document.querySelector("#historyTable tbody");

            let counter = 0;

            function setStatus(type, text) {
                statusEl.className = "status " + type;
                statusEl.textContent = text;
            }

            function addRow(payload, result) {
                // remove empty row
                const empty = tableBody.querySelector(".empty");
                if (empty) empty.remove();

                counter += 1;
                const tr = document.createElement("tr");

                const now = new Date();
                const time = now.toLocaleString();

                const score = result?.fraud_score ?? "‚Äî";
                const isFraud = result?.is_fraud ?? "‚Äî";

                tr.innerHTML = `
        <td>${counter}</td>
        <td>${payload.amount}</td>
        <td>${payload.transactions_last_hour}</td>
        <td>${payload.distance_from_last_location}</td>
        <td>${score}</td>
        <td>
          <span class="pill ${isFraud === true ? "pill-bad" : isFraud === false ? "pill-good" : ""}">
            ${isFraud}
          </span>
        </td>
        <td>${time}</td>
      `;
                tableBody.prepend(tr);
            }

            fillFraudBtn.addEventListener("click", () => {
                form.amount.value = 95000;
                form.transactions_last_hour.value = 18;
                form.distance_from_last_location.value = 1200; // —Ä–µ–∑–∫–∞—è —Å–º–µ–Ω–∞ –ª–æ–∫–∞—Ü–∏–∏
            });

            clearBtn.addEventListener("click", () => {
                counter = 0;
                tableBody.innerHTML = `
        <tr class="empty">
          <td colspan="7">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤.</td>
        </tr>
      `;
                scoreEl.textContent = "‚Äî";
                isFraudEl.textContent = "‚Äî";
                rawEl.textContent = "{}";
                setStatus("status-idle", "–û–∂–∏–¥–∞—é –∑–∞–ø—Ä–æ—Å‚Ä¶");
            });

            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                const payload = {
                    amount: Number(form.amount.value),
                    transactions_last_hour: Number(
                        form.transactions_last_hour.value,
                    ),
                    distance_from_last_location: Number(
                        form.distance_from_last_location.value,
                    ),
                };

                setStatus("status-loading", "–û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–ø—Ä–æ—Å –≤ API‚Ä¶");

                try {
                    // Use GET request with query params to avoid CSRF issues
                    const params = new URLSearchParams({
                        amount: String(payload.amount),
                        transactions_last_hour: String(
                            payload.transactions_last_hour,
                        ),
                        distance_from_last_location: String(
                            payload.distance_from_last_location,
                        ),
                    });

                    const res = await fetch(API + "?" + params.toString(), {
                        method: "GET",
                        headers: { Accept: "application/json" },
                    });

                    if (!res.ok) throw new Error("HTTP " + res.status);

                    const data = await res.json();

                    scoreEl.textContent = String(data.fraud_score ?? "‚Äî");
                    isFraudEl.textContent = String(data.is_fraud ?? "‚Äî");
                    rawEl.textContent = JSON.stringify(data, null, 2);

                    // Update gauge: percent relative to threshold
                    const threshold = data?.components?.threshold ?? 60;
                    const pct = Math.min(
                        100,
                        Math.round(((data.fraud_score ?? 0) / threshold) * 100),
                    );
                    const gfill = document.getElementById("gfill");
                    const glabel = document.getElementById("glabel");
                    gfill.style.width = pct + "%";
                    glabel.textContent = pct + "%";

                    if (data.is_fraud === true) {
                        setStatus(
                            "status-bad",
                            "‚ö†Ô∏è –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (FRAUD)",
                        );
                        gfill.style.filter = "hue-rotate(340deg)";
                    } else if (data.is_fraud === false) {
                        setStatus(
                            "status-good",
                            "‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–≥–ª—è–¥–∏—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ",
                        );
                        gfill.style.filter = "hue-rotate(110deg)";
                    } else {
                        setStatus(
                            "status",
                            "–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç (–±–µ–∑ —Ñ–ª–∞–≥–∞ is_fraud)",
                        );
                        gfill.style.filter = "none";
                    }

                    addRow(payload, data);
                } catch (err) {
                    setStatus("status-bad", "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: " + err.message);
                }
            });
        </script>
    </body>
</html>
